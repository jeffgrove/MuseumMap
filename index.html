<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Museum Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Favicon links - sometimes browsers prefer one type over another -->
  <link rel="icon" href="favicon.ico" sizes="any">
  <link rel="icon" type="image/png" href="favicon.png">

  <!-- Leaflet CSS (no SRI to avoid integrity mismatches) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
      html, body, #map { height: 100%; margin: 0; }
      .panel {
          position: absolute; z-index: 1000;
          top: 10px; left: 10px;
          background: rgba(255,255,255,0.95);
          padding: 10px 12px;
          border-radius: 6px;
          box-shadow: 0 2px 10px rgba(0,0,0,.2);
          font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
          max-width: 320px;
      }
      .panel h1 {
          font-size: 16px; margin: 0 0 6px; font-weight: 600;
      }
      .row { display: flex; gap: 8px; align-items: center; margin-top: 6px; }
      select, input[type="text"] {
          font: inherit; padding: 6px 8px; border-radius: 4px; border: 1px solid #ccc;
      }
      .legend {
          margin-top: 8px; font-size: 13px;
      }
      .dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 6px; vertical-align: middle; }
  </style>
</head>
<body>
<div id="map"></div>

<div class="panel">
  <h1>Museums</h1>

  <div class="row">
    <label for="typeFilter" style="white-space:nowrap;">Type:</label>
    <select id="typeFilter">
      <option value="">All types</option>
    </select>
  </div>

  <div id="counts" class="row" style="margin-top:8px; color:#333;"></div>

  <div class="legend">
    <div><span class="dot" style="background:#E63946;"></span>Art</div>
    <div><span class="dot" style="background:#43AA8B;"></span>Botanical and Nature</div>
    <div><span class="dot" style="background:#4CC9F0;"></span>Children's</div>
    <div><span class="dot" style="background:#F9c74f;"></span>History</div>
    <div><span class="dot" style="background:#F3722C;"></span>Natural History and Natural Science</div>
    <div><span class="dot" style="background:#720987;"></span>Science And Technology</div>
    <div><span class="dot" style="background:#4361EE;"></span>Zoo, Aquarium and Wildlife</div>
  </div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    // --- Map setup ---
    const map = L.map('map', { zoomControl: true }).setView([39, -98], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18, attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
  
    // Radius scale based on zoom (tweak as you like)
    function radiusForZoom(z) {
        const r = 3 * Math.pow(1.25, z - 4); // grows ~25% per zoom level
        return Math.max(3, Math.min(18, r)); // clamp between 3 and 18 px
    }
  
    // --- Color mapping by museum type ---
    function colorForType(type) {
        if (!type) return '#808080';
        const t = String(type).toLowerCase();
        if (t.includes('art')) return '#E63946';
        if (t.includes('botanical')) return '#43AA8B';
        if (t.includes('children')) return '#4CC9F0';
        if (t.includes('natural')) return '#F3722C'; // before history to catch "natural history"
        if (t.includes('history')) return '#F9c74f';
        if (t.includes('science')) return '#720987';
        if (t.includes('zoo')) return '#4361EE';
        return '#808080';
    }
  
    // --- Global state ---
    let allFeatures = [];     // raw features from GeoJSON
    let layer = null;         // current Leaflet layer
    const typeSelect = document.getElementById('typeFilter');
    const countsEl = document.getElementById('counts');
    let zoomHandlerAttached = false;
  
    // Resize all circle markers in-place
    function resizeMarkers() {
      if (!layer) return;
      const r = radiusForZoom(map.getZoom());
      layer.eachLayer(l => {
        // l is a CircleMarker for point features
        if (l.setRadius) l.setRadius(r);
        // if you ever wrap markers in groups, also iterate inner:
        if (l.eachLayer) l.eachLayer(inner => inner.setRadius && inner.setRadius(r));
      });
    }
  
    // --- Render function (applies filter and redraws) ---
    function render(typeFilterValue) {
        if (layer) {
            map.removeLayer(layer);
            layer = null;
        }
  
        const filtered = allFeatures.filter(f => {
            if (!typeFilterValue) return true; // show all
            const t = (f.properties?.Type || '').toString().trim().toLowerCase();
            return t.match(typeFilterValue.toLowerCase());
        });
  
        const initialRadius = radiusForZoom(map.getZoom());
  
        layer = L.geoJSON({ type: 'FeatureCollection', features: filtered }, {
            pointToLayer: (f, latlng) => {
                const color = colorForType(f.properties?.Type);
                return L.circleMarker(latlng, {
                    radius: initialRadius,  // initial size
                    color, fillColor: color, fillOpacity: 0.9, weight: 1
                });
            },
            onEachFeature: (f, l) => {
                const p = f.properties || {};
                const name = p.Name || 'Unnamed museum';
                const addr = p.Address || '';
                const city = p.City || '';
                const state = p.State || '';
                const zip = p.Zip || '';
                const phone = p.Phone || '';
                const url = p.URL || p.Url || '';
                const lineCity = city && state ? `${city}, ${state}` : (city || state || '');
                const lineAddr = [addr, zip].filter(Boolean).join(' ');
                const link = url ? `<br><a href="${url}" target="_blank" rel="noopener">${url}</a>` : '';
                l.bindPopup(`
                    <strong>${name}</strong><br>
                    ${lineAddr ? lineAddr + '<br>' : ''}
                    ${lineCity ? lineCity + '<br>' : ''}
                    ${phone ? phone + '<br>' : '' }
                    ${p.Type ? `<em>${p.Type}</em>` : ''}${link}
                `);
            }
        }).addTo(map);
  
        // Update counts
        countsEl.textContent = `Showing ${filtered.length.toLocaleString()} of ${allFeatures.length.toLocaleString()} museums`;

        // Fit bounds (guard for empty)
        const b = layer.getBounds();
        if (b.isValid()) {
            map.fitBounds(b, { padding: [20, 20] });
        }

        // Attach zoom handler once; it resizes existing markers using .setRadius
        if (!zoomHandlerAttached) {
            map.on('zoomend', resizeMarkers);
            zoomHandlerAttached = true;
        }

        // Ensure current size matches current zoom
        resizeMarkers();
    }
  
    // --- Load data and initialize UI ---
    fetch('museums.geojson', { cache: 'no-store' })
        .then(res => {
            if (!res.ok) throw new Error(`Failed to load museums.geojson: ${res.status}`);
            return res.json();
        })
        .then(geo => {
            if (!geo || !Array.isArray(geo.features)) throw new Error('Invalid GeoJSON format');
            allFeatures = geo.features;

            // Build the type dropdown from data
            const typeSet = new Set();
            allFeatures.forEach(f => {
                const raw = (f.properties?.Type || '').toString().trim();
                if (raw) typeSet.add(raw);
            });

            // Sort types alphabetically (case-insensitive)
            const types = Array.from(typeSet).sort((a,b)=>a.toLowerCase().localeCompare(b.toLowerCase()));
            types.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t; opt.textContent = t;
                typeSelect.appendChild(opt);
            });

            // Initial render (All)
            render('');

            // Hook up filter change
            typeSelect.addEventListener('change', () => {
                render(typeSelect.value);
            });
        })
        .catch(err => {
            console.error(err);
            countsEl.textContent = 'Error loading data';
        });
</script>
  
</body>
</html>
